<!DOCTYPE html>
<html>
<head>
    <title>Laboratory Decision Study</title>
    <script src="https://unpkg.com/jspsych@8.0.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="styles.css" rel="stylesheet" type="text/css" />
    <script src="shared.js"></script>
</head>
<body></body>
<script>
// =============================================================================
// CONFIGURATION AND SETUP
// =============================================================================

// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const prolificPID = urlParams.get('PROLIFIC_PID') || 'unknown';
const studyID = urlParams.get('STUDY_ID') || 'unknown';
const sessionID = urlParams.get('SESSION_ID') || 'unknown';

// Experiment 1: Goal (between-subjects) x Base Rate (within-subjects)
const expVersion = 'exp1';

// Condition assignment (can be set via URL or random)
let goalCondition = urlParams.get('goal') || null;  // 'find' or 'avoid'

// Random assignment if not specified
if (!goalCondition) {
    goalCondition = Math.random() < 0.5 ? 'find' : 'avoid';
}

// Exp1 is always singleton decision structure
const decisionStructure = 'singleton';

// Test mode - skip button delays for faster testing
const testMode = urlParams.get('testMode') === 'true';
const buttonDisableTime = testMode ? 100 : 2000;

// Number of vials (10 for exp1)
const nVials = 10;

// =============================================================================
// EXPERIMENT-SPECIFIC HELPERS
// =============================================================================

// Goal configuration (singleton only for exp1)
function getGoalConfig() {
    const configs = {
        find: {
            text: 'Find a <strong>safe</strong> vial to use',
            icon: '‚úì',
            cssClass: 'find-goal'
        },
        avoid: {
            text: 'Avoid picking a <strong>contaminated</strong> vial',
            icon: '‚ö†',
            cssClass: 'avoid-goal'
        }
    };
    return configs[goalCondition];
}

// =============================================================================
// JSPSYCH INITIALIZATION
// =============================================================================

const jsPsych = initJsPsych({
    on_finish: function() {
        const finalData = {
            prolific_pid: prolificPID,
            study_id: studyID,
            session_id: sessionID,
            exp_version: expVersion,
            goal_condition: goalCondition,
            decision_structure: decisionStructure,
            trials: jsPsych.data.get().values(),
            completion_time: new Date().toISOString()
        };
        showCompletionScreen(jsPsych, finalData, 'WHQPOL2024', prolificPID);
    }
});

// =============================================================================
// TIMELINE CONSTRUCTION
// =============================================================================

let timeline = [];

// -----------------------------------------------------------------------------
// WELCOME AND CONSENT
// -----------------------------------------------------------------------------

const welcome = {
    type: jsPsychHtmlButtonResponse,
    stimulus: CONSENT_HTML,
    choices: ['Continue'],
    data: { trial_type: 'consent' }
};
timeline.push(welcome);

// -----------------------------------------------------------------------------
// VISUAL INSTRUCTIONS (5 pages)
// -----------------------------------------------------------------------------

function getVisualInstructionPages() {
    const pages = [];

    // Page 1: Your Lab Bench
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">üß™ Your Lab Bench</h2>
            <p class="instruction-text">You work in a laboratory with biological samples stored in vials.</p>
            ${renderVialRack(nVials)}
            <p class="instruction-text">You have <strong>${nVials} vials</strong> on your bench.</p>
            <p class="instruction-text" style="color: #666;">Currently, you don't know which are safe to use...</p>
        </div>
    `);

    // Page 2: The Problem
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">‚ö†Ô∏è The Problem</h2>
            <p class="instruction-text">Some vials are <strong style="color: var(--safe-color);">safe</strong> (uncontaminated) and some are <strong style="color: var(--danger-color);">contaminated</strong> (dangerous).</p>
            <p class="instruction-text">But you can't tell which is which just by looking!</p>
            <div style="display: flex; justify-content: center; gap: 40px; margin: 30px 0;">
                <div style="text-align: center;">
                    ${renderVial('', 'safe', false)}
                    <div style="margin-top: 10px; color: var(--safe-color); font-weight: bold;">Safe ‚úì</div>
                </div>
                <div style="text-align: center;">
                    ${renderVial('', 'danger', false)}
                    <div style="margin-top: 10px; color: var(--danger-color); font-weight: bold;">Contaminated ‚ò†</div>
                </div>
                <div style="text-align: center;">
                    ${renderVial('', 'unknown', false)}
                    <div style="margin-top: 10px; color: var(--unknown-color); font-weight: bold;">Unknown ?</div>
                </div>
            </div>
            <p class="instruction-text">You need to figure out which vials are which before making your decision.</p>
        </div>
    `);

    // Page 3: Your Assistant
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">üî¨ Your Lab Assistant</h2>
            <div class="assistant-avatar">üë®‚Äçüî¨</div>
            <p class="instruction-text">You have a lab assistant who can help. You can ask them <strong>ONE question</strong>.</p>
            <div class="instruction-emphasis">
                <strong>Important:</strong> Your assistant has tested <strong>some</strong> vials, but <strong>not all</strong> of them!
            </div>
            <div class="partial-knowledge-demo">
                <div class="knowledge-column">
                    <h4>Tested</h4>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        ${renderVial('', 'safe', false)}
                        ${renderVial('', 'danger', false)}
                    </div>
                    <p style="font-size: 14px; color: #666;">Assistant knows these</p>
                </div>
                <div class="knowledge-column">
                    <h4>Not Tested</h4>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        ${renderVial('', 'unknown', false)}
                        ${renderVial('', 'unknown', false)}
                        ${renderVial('', 'unknown', false)}
                    </div>
                    <p style="font-size: 14px; color: #666;">Assistant doesn't know these</p>
                </div>
            </div>
            <p class="instruction-text">They can only tell you about vials they've tested.</p>
        </div>
    `);

    // Page 4: Your Goal (different for FIND vs AVOID)
    if (goalCondition === 'find') {
        pages.push(`
            <div class="instruction-container fade-in">
                <h2 class="instruction-title">üéØ Your Goal</h2>
                <p class="instruction-text">Your experiment needs a clean sample. You must pick <strong>ONE vial</strong> to use.</p>
                <div class="outcome-demo">
                    <div class="outcome-box success">
                        <div class="outcome-icon">‚úì</div>
                        ${renderVial('', 'safe', false)}
                        <div class="outcome-label">Success!</div>
                        <p style="font-size: 14px; margin: 5px 0;">Picked a safe vial</p>
                    </div>
                    <div class="outcome-box failure">
                        <div class="outcome-icon">üí•</div>
                        ${renderVial('', 'danger', false)}
                        <div class="outcome-label">Failure!</div>
                        <p style="font-size: 14px; margin: 5px 0;">Sample ruined</p>
                    </div>
                </div>
                <div class="goal-card find-goal">
                    <span class="icon">‚úì</span>
                    <span><strong>Your Goal:</strong> Find an uncontaminated vial to use</span>
                </div>
            </div>
        `);
    } else {
        pages.push(`
            <div class="instruction-container fade-in">
                <h2 class="instruction-title">üéØ Your Goal</h2>
                <p class="instruction-text">Contaminated vials are <strong>dangerous</strong>‚Äîthey'll destroy your equipment!</p>
                <p class="instruction-text">You must pick <strong>ONE vial</strong> carefully.</p>
                <div class="outcome-demo">
                    <div class="outcome-box success">
                        <div class="outcome-icon">‚úì</div>
                        ${renderVial('', 'safe', false)}
                        <div class="outcome-label">Safe!</div>
                        <p style="font-size: 14px; margin: 5px 0;">Equipment intact</p>
                    </div>
                    <div class="outcome-box failure">
                        <div class="outcome-icon">üí•</div>
                        ${renderVial('', 'danger', false)}
                        <div class="outcome-label">Disaster!</div>
                        <p style="font-size: 14px; margin: 5px 0;">Equipment destroyed!</p>
                    </div>
                </div>
                <div class="goal-card avoid-goal">
                    <span class="icon">‚ö†</span>
                    <span><strong>Your Goal:</strong> Avoid picking a contaminated vial</span>
                </div>
            </div>
        `);
    }

    // Page 5: Your Question Choice
    pages.push(`
        <div class="instruction-container fade-in">
            <h2 class="instruction-title">‚ùì Your Question</h2>
            <p class="instruction-text">Before deciding, you can ask your assistant a question about the vials.</p>
            <p class="instruction-text">You'll complete a sentence that starts with:</p>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 25px 0; font-size: 22px;">
                <span>"Which vials are</span>
                <span style="border-bottom: 2px solid #333; min-width: 150px; display: inline-block;">&nbsp;</span>
                <span>?"</span>
            </div>
            <p class="instruction-text">Type your completion in the text box provided.</p>
            <p class="instruction-text">Think about which question would give you the most useful information for <strong>your goal</strong>.</p>
            <div class="instruction-emphasis">
                You'll complete <strong>3 trials</strong> with different contamination rates.
            </div>
        </div>
    `);

    return pages;
}

const instructions = {
    type: jsPsychInstructions,
    pages: getVisualInstructionPages(),
    show_clickable_nav: true,
    button_label_previous: 'Back',
    button_label_next: 'Next',
    data: { trial_type: 'instructions' }
};
timeline.push(instructions);

// -----------------------------------------------------------------------------
// COMPREHENSION CHECKS (using shared functions)
// -----------------------------------------------------------------------------

timeline.push(createComprehensionCheck1(jsPsych, goalCondition, decisionStructure));
timeline.push(createComprehensionCheck2(jsPsych));

// -----------------------------------------------------------------------------
// TRIAL STIMULUS HELPER
// -----------------------------------------------------------------------------

function createTrialStimulus(baseRate, trialNum = null, totalTrials = null) {
    const trialHeader = (trialNum !== null)
        ? `<div class="trial-header">Trial ${trialNum} of ${totalTrials}</div>`
        : '';

    return `
        <div class="trial-container">
            ${trialHeader}
            ${renderVialRack(nVials)}
            ${renderProportionBar(baseRate, nVials)}
            <div class="goal-card ${getGoalConfig().cssClass}">
                <span class="icon">${getGoalConfig().icon}</span>
                <span><strong>Your Goal:</strong> ${getGoalConfig().text}</span>
            </div>
        </div>
    `;
}

// -----------------------------------------------------------------------------
// MAIN EXPERIMENTAL TRIALS
// -----------------------------------------------------------------------------

function generateTrialList() {
    const baseRates = [0.2, 0.5, 0.8];
    const trials = baseRates.map(br => ({
        base_rate: br,
        trial_id: `exp1_br${br}`
    }));
    return jsPsych.randomization.shuffle(trials);
}

const trialList = generateTrialList();
const totalTrials = trialList.length;

const mainTrialProcedure = {
    timeline: [
        {
            type: jsPsychSurveyHtmlForm,
            html: function() {
                const baseRate = jsPsych.evaluateTimelineVariable('base_rate');
                const trialIndex = jsPsych.evaluateTimelineVariable('trial_index');
                return `
                    ${createTrialStimulus(baseRate, trialIndex + 1, totalTrials)}
                    <div class="sentence-completion">
                        <span>"Which vials are</span>
                        <input type="text" id="completion" name="completion" placeholder="type here..." autocomplete="off" required>
                        <span>?"</span>
                    </div>
                `;
            },
            autofocus: 'completion',
            button_label: 'Submit',
            data: {
                trial_type: 'main_trial',
                trial_id: jsPsych.timelineVariable('trial_id'),
                base_rate: jsPsych.timelineVariable('base_rate'),
                trial_index: jsPsych.timelineVariable('trial_index'),
                exp_version: expVersion,
                goal_condition: goalCondition,
                decision_structure: decisionStructure
            },
            on_load: function() {
                const submitBtn = document.querySelector('#jspsych-survey-html-form-next');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                    }, buttonDisableTime);
                }
            },
            on_finish: function(data) {
                const response = data.response.completion.trim().toLowerCase();
                data.raw_response = data.response.completion.trim();
                data.response_lowercase = response;
                data.chose_which_contaminated = response.includes('contaminated') || response.includes('dangerous') || response.includes('unsafe');
                data.chose_which_uncontaminated = response.includes('uncontaminated') || response.includes('safe') || response.includes('clean');
            }
        },
        {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size: 48px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500,
            data: { trial_type: 'iti' }
        }
    ],
    timeline_variables: trialList.map((trial, index) => ({
        ...trial,
        trial_index: index
    }))
};
timeline.push(mainTrialProcedure);

// -----------------------------------------------------------------------------
// POST-TASK QUESTIONS
// -----------------------------------------------------------------------------

const strategyProbe = {
    type: jsPsychSurveyText,
    questions: [
        {
            prompt: '<h3>Strategy Question</h3><p>How did you decide how to complete your question on each trial? Please describe your reasoning or strategy:</p>',
            name: 'strategy',
            rows: 5,
            columns: 60,
            required: true
        }
    ],
    data: { trial_type: 'strategy_probe' }
};
timeline.push(strategyProbe);

// -----------------------------------------------------------------------------
// DEMOGRAPHICS
// -----------------------------------------------------------------------------

const demographics = {
    type: jsPsychSurveyHtmlForm,
    html: DEMOGRAPHICS_HTML,
    data: { trial_type: 'demographics' }
};
timeline.push(demographics);

// -----------------------------------------------------------------------------
// DEBRIEF
// -----------------------------------------------------------------------------

const debrief = {
    type: jsPsychHtmlButtonResponse,
    stimulus: DEBRIEF_HTML,
    choices: ['Finish and Get Completion Code'],
    data: { trial_type: 'debrief' }
};
timeline.push(debrief);

// =============================================================================
// RUN EXPERIMENT
// =============================================================================

jsPsych.run(timeline);

</script>
</html>
